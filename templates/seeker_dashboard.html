<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Job Seeker Dashboard | CareerConnect</title>
    <!-- Bootstrap CDN -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN"
      crossorigin="anonymous"
    />
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}" />
  </head>
  <body style="background: #f5f7fb;">
    <!-- Top Navbar -->
    <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm sticky-top" style="z-index: 1020;">
      <div class="container-fluid">
        <a class="navbar-brand fw-bold text-primary" href="{{ url_for('seeker_dashboard') }}">CareerConnect</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#seekerNav" aria-controls="seekerNav" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="seekerNav">
          <div class="ms-auto">
            <a class="btn btn-outline-danger btn-sm" href="{{ url_for('logout') }}">Logout</a>
          </div>
        </div>
      </div>
    </nav>

    <div class="container-fluid py-4">
      <!-- Header -->
      <div class="d-flex flex-wrap align-items-center justify-content-between mb-4 gap-3">
        <div>
          <h2 class="mb-1">
            Welcome back,
            <span class="text-primary">{{ profile.full_name or profile.username or 'Job Seeker' }}</span>
          </h2>
          <p class="text-muted mb-0">Track your applications, recommendations, and resume insights</p>
        </div>
        <div class="d-flex gap-2">
          <a class="btn btn-outline-primary" href="{{ url_for('seeker_profile') }}">Edit Profile</a>
          <a class="btn btn-primary" href="{{ url_for('upload_resume') }}">Upload / Replace Resume</a>
        </div>
      </div>

      <div class="row g-4">
        <!-- Profile summary -->
        <div class="col-xl-3 col-lg-4" id="profile">
          <div class="card h-100 shadow-sm">
            <div class="card-body">
              <div class="d-flex align-items-center mb-3">
                <div class="rounded-circle bg-primary bg-opacity-10 text-primary d-flex align-items-center justify-content-center" style="width: 48px; height: 48px; font-weight: 700;">
                  {{ (profile.full_name or profile.username or 'JS')[:2]|upper if profile else 'JS' }}
                </div>
                <div class="ms-3">
                  <h5 class="mb-0">{{ profile.full_name or 'Your Name' }}</h5>
                  <small class="text-muted">{{ profile.education or 'Your education' }}</small>
                </div>
              </div>
              <ul class="list-unstyled mb-3 small text-muted">
                <li class="mb-1">Username: {{ profile.username or '-' }}</li>
                <li class="mb-1">Email: {{ profile.email or '-' }}</li>
                <li class="mb-1">Experience: {{ profile.experience_years or '0' }} years</li>
                <li class="mb-1">Primary skills: {{ profile.primary_skills or '-' }}</li>
              </ul>
              {% if resume %}
              <div class="small text-muted mb-3">
                <strong>Resume:</strong>
                <span>{{ resume.original_filename or resume.filename }}</span>
                <div class="mt-2">
                  <a class="btn btn-sm btn-outline-primary" href="{{ url_for('upload_resume') }}">Replace</a>
                </div>
              </div>
              {% else %}
              <div class="small text-muted mb-3">
                <strong>Resume:</strong> <span class="text-muted">No resume uploaded</span>
                <div class="mt-2">
                  <a class="btn btn-sm btn-primary" href="{{ url_for('upload_resume') }}">Upload Resume</a>
                </div>
              </div>
              {% endif %}

              <a class="btn btn-outline-primary w-100" href="{{ url_for('seeker_profile') }}">View / Edit Profile</a>
            </div>
          </div>
        </div>

        <!-- AI Insights & Quick Actions -->
        <div class="col-xl-9 col-lg-8">
          <div class="row g-4">
            <div class="col-md-6">
              <div class="card h-100 shadow-sm">
                <div class="card-body">
                  <div class="d-flex justify-content-between align-items-start mb-2">
                    <h5 class="mb-0">AI Resume Insights</h5>
                    <span class="badge bg-primary bg-opacity-10 text-primary">Latest</span>
                  </div>
                  <div class="d-flex align-items-center my-3">
                    {% if analysis %}
                    <div id="ats-score" class="display-6 fw-bold text-primary me-3">{{ analysis.ats.ats_score }}</div>
                    <div class="small text-muted">ATS Score</div>
                    {% else %}
                    <div id="ats-score" class="display-6 fw-bold text-primary me-3">--</div>
                    <div class="small text-muted">ATS Score</div>
                    {% endif %}
                  </div>
                  <div class="small">
                    {% if analysis %}
                      <p class="mb-1"><strong>Extracted skills:</strong> <span id="extracted-skills">{{ analysis.extracted_skills | join(', ') }}</span></p>
                      <p class="mb-1"><strong>Missing skills:</strong> <span id="missing-skills">{{ analysis.ats.missing_skills | join(', ') if analysis.ats.missing_skills else 'None' }}</span></p>
                      {% if analysis.suggestions %}
                        <p class="mb-1"><strong>Suggestions:</strong> <span id="suggestions">{{ analysis.suggestions | join('; ') }}</span></p>
                      {% else %}
                        <p class="mb-1"><strong>Suggestions:</strong> <span id="suggestions">None</span></p>
                      {% endif %}
                    {% else %}
                      <p class="mb-1"><strong>Skill gaps:</strong> AWS, Docker</p>
                      <p class="mb-1"><strong>Suggestions:</strong> Add project metrics; include cloud keywords.</p>
                    {% endif %}
                  </div>
                  <div class="d-flex gap-2 mt-3">
                    <button id="rerun-analysis" class="btn btn-primary flex-grow-1">Re-run Analysis</button>
                    <button id="view-details" class="btn btn-outline-secondary flex-grow-1" onclick="location.href='{{ url_for('analysis_details', job_role=selected_role) }}'">View Details</button>
                  </div>
                </div>
              </div>
            </div>

            <div class="col-md-6">
              <div class="card h-100 shadow-sm">
                <div class="card-body">
                  <h5 class="mb-3">Quick Actions</h5>
                  <div class="d-grid gap-2">
                    <button class="btn btn-outline-primary">Search Jobs</button>
                    <button class="btn btn-outline-primary">Update Skills</button>
                    <button class="btn btn-outline-primary">View Saved Jobs</button>
                    <button class="btn btn-outline-primary">Check Application Status</button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Recommended Jobs -->
      <div class="card mt-4 shadow-sm" id="recommended">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="mb-0">Recommended Jobs</h5>
            <div class="d-flex gap-2">
              <select class="form-select form-select-sm" style="width: 180px;">
                <option selected>Sort by: Recently Posted</option>
                <option>Job Title</option>
                <option>Location</option>
                <option>Experience Level</option>
              </select>
              <input class="form-control form-control-sm" style="width: 200px;" placeholder="Filter by skill or title" />
            </div>
          </div>
          <div class="row g-3">
            {% if job_postings and job_postings|length > 0 %}
              {% for job in job_postings %}
              <div class="col-lg-4 col-md-6">
                <div class="card h-100 border-0 shadow-sm">
                  <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                      <div>
                        <h6 class="mb-1">{{ job.job_title }}</h6>
                        <small class="text-muted">{{ job.company_name }} • {{ job.job_location }}</small>
                      </div>
                      <span class="badge bg-primary bg-opacity-10 text-primary">Match --</span>
                    </div>
                    <p class="small text-muted mt-2 mb-2">{{ job.required_skills | truncate(60) }}</p>
                    <div class="d-flex gap-2">
                      {% if job.id in applied_job_ids %}
                        <button class="btn btn-sm btn-success" disabled>Applied</button>
                      {% else %}
                        <form method="POST" action="{{ url_for('apply_job', job_id=job.id) }}" class="apply-form" data-job-id="{{ job.id }}" style="display: inline;">
                          <button type="submit" class="btn btn-sm btn-primary apply-btn">Apply</button>
                        </form>
                      {% endif %}
                      {% if job.id in saved_job_ids %}
                        <button class="btn btn-sm btn-warning save-btn" data-job-id="{{ job.id }}">Saved</button>
                      {% else %}
                        <button class="btn btn-sm btn-outline-secondary save-btn" data-job-id="{{ job.id }}">Save</button>
                      {% endif %}
                    </div>
                  </div>
                </div>
              </div>
              {% endfor %}
            {% else %}
              <div class="col-12">
                <p class="text-muted text-center py-4">No job postings available at the moment.</p>
              </div>
            {% endif %}
          </div>
        </div>
      </div>

      <!-- Applications & Saved jobs -->
      <div class="row g-4 mt-1">
        <div class="col-lg-8" id="applications">
          <div class="card shadow-sm h-100">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="mb-0">My Applications</h5>
                <select class="form-select form-select-sm" style="width: 160px;">
                  <option selected>All statuses</option>
                  <option>Applied</option>
                  <option>Shortlisted</option>
                  <option>Rejected</option>
                  <option>Hired</option>
                </select>
              </div>
              <div class="table-responsive">
                <table class="table align-middle mb-0">
                  <thead class="table-light">
                    <tr>
                      <th>Role</th>
                      <th>Company</th>
                      <th>Status</th>
                      <th>Applied</th>
                      <th>Match</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% if applications and applications|length > 0 %}
                      {% for app in applications %}
                      <tr>
                        <td>{{ app.job_title }}</td>
                        <td>{{ app.company_name }}</td>
                        <td>
                          {% if app.status == 'applied' %}
                            <span class="badge bg-secondary">Applied</span>
                          {% elif app.status == 'shortlisted' %}
                            <span class="badge bg-info text-dark">Shortlisted</span>
                          {% elif app.status == 'rejected' %}
                            <span class="badge bg-danger">Rejected</span>
                          {% elif app.status == 'hired' %}
                            <span class="badge bg-success">Hired</span>
                          {% endif %}
                        </td>
                        <td><small class="text-muted">{{ app.applied_at[:10] if app.applied_at else '-' }}</small></td>
                        <td><span class="badge bg-primary bg-opacity-10 text-primary">--</span></td>
                      </tr>
                      {% endfor %}
                    {% else %}
                      <tr>
                        <td colspan="5" class="text-muted text-center py-4">No applications yet. Start applying to jobs!</td>
                      </tr>
                    {% endif %}
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>

        <div class="col-lg-4" id="saved">
          <div class="card shadow-sm h-100">
            <div class="card-body">
              <h5 class="mb-3">Saved Jobs</h5>
              <div class="list-group small">
                {% if saved_jobs and saved_jobs|length > 0 %}
                  {% for job in saved_jobs %}
                  <a class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                    <div>
                      <div class="fw-semibold">{{ job.job_title }}</div>
                      <div class="text-muted">{{ job.company_name }} • {{ job.job_location }}</div>
                    </div>
                    {% if job.id in applied_job_ids %}
                      <span class="badge bg-success">Applied</span>
                    {% else %}
                      <form method="POST" action="{{ url_for('apply_job', job_id=job.id) }}" class="apply-form" data-job-id="{{ job.id }}" style="display: inline;">
                        <button type="submit" class="btn btn-sm btn-outline-primary apply-btn">Apply</button>
                      </form>
                    {% endif %}
                  </a>
                  {% endfor %}
                {% else %}
                  <p class="text-muted text-center py-4">No saved jobs yet</p>
                {% endif %}
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL"
      crossorigin="anonymous"
    ></script>
    
  </body>
</html>

    <!-- Analysis modal -->
    <div class="modal fade" id="analysisModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-body text-center py-4">
            <div id="analysis-modal-text" class="fw-semibold">Analysing</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Application success modal -->
    <div class="modal fade" id="applicationSuccessModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-body text-center py-4">
            <div class="text-success mb-3">
              <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" fill="currentColor" class="bi bi-check-circle" viewBox="0 0 16 16">
                <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
                <path d="M10.97 4.97a.235.235 0 0 0-.02.022L7.477 9.417 5.384 7.323a.75.75 0 0 0-1.06 1.06L6.97 11.03a.75.75 0 0 0 1.079-.02l3.992-4.99a.75.75 0 0 0-1.071-1.05z"/>
              </svg>
            </div>
            <h5 class="fw-semibold">Applied Successfully!</h5>
            <p class="text-muted mb-0">Your application has been submitted.</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Save job success modal -->
    <div class="modal fade" id="saveSuccessModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-body text-center py-4">
            <div class="text-warning mb-3">
              <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" fill="currentColor" class="bi bi-bookmark-check" viewBox="0 0 16 16">
                <path fill-rule="evenodd" d="M10.854 5.146a.5.5 0 0 1 0 .708l-3 3a.5.5 0 0 1-.708 0l-1.5-1.5a.5.5 0 1 1 .708-.708L7.5 7.793l2.646-2.647a.5.5 0 0 1 .708 0z"/>
                <path d="M2 2a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v13.5a.5.5 0 0 1-.777.416L8 13.101l-5.223 2.815A.5.5 0 0 1 2 15.5V2zm2-1a1 1 0 0 0-1 1v12.566l4.723-2.482a.5.5 0 0 1 .554 0L13 14.566V2a1 1 0 0 0-1-1H4z"/>
              </svg>
            </div>
            <h5 class="fw-semibold" id="save-modal-title">Job Saved!</h5>
            <p class="text-muted mb-0" id="save-modal-text">Job added to your saved list.</p>
          </div>
        </div>
      </div>
    </div>

    <script>
      (function(){
        const rerunBtn = document.getElementById('rerun-analysis');
        const modalEl = document.getElementById('analysisModal');
        const modalText = document.getElementById('analysis-modal-text');
        const bsModal = modalEl ? new bootstrap.Modal(modalEl, { backdrop: 'static', keyboard: false }) : null;
        if (!rerunBtn) return;

        function sleep(ms){ return new Promise(r => setTimeout(r, ms)); }

        rerunBtn.addEventListener('click', async function(){
          try{
            if (bsModal){
              modalText.innerText = 'Analysing';
              bsModal.show();
            }

            rerunBtn.disabled = true;

            // Start fetch in parallel
            const fetchPromise = fetch('{{ url_for('rerun_analysis') }}', { method: 'POST', headers: { 'X-Requested-With': 'XMLHttpRequest' } });

            // Always show 'Analysing' for 2000ms
            await sleep(2000);

            // Show completed after 2s
            if (modalText) modalText.innerText = 'Completed';

            // Wait for fetch to finish (if still running)
            let resp = null;
            try{ resp = await fetchPromise; } catch(e){ resp = null; }

            let data = null;
            if (resp && resp.ok){
              data = await resp.json().catch(()=>null);
            } else if (resp){
              const j = await resp.json().catch(()=>({}));
              alert('Failed to re-run analysis: ' + (j.error || resp.statusText));
            }

            if (data){
              const ats = document.getElementById('ats-score');
              const extracted = document.getElementById('extracted-skills');
              const missing = document.getElementById('missing-skills');
              const suggestions = document.getElementById('suggestions');

              if (ats && data.ats && typeof data.ats.ats_score !== 'undefined') ats.innerText = data.ats.ats_score;
              if (extracted && Array.isArray(data.extracted_skills)) extracted.innerText = data.extracted_skills.join(', ');
              if (missing && data.ats) missing.innerText = (data.ats.missing_skills && data.ats.missing_skills.length) ? data.ats.missing_skills.join(', ') : 'None';
              if (suggestions) suggestions.innerText = (data.suggestions && data.suggestions.length) ? data.suggestions.join('; ') : 'None';
            }

            // Close modal shortly after showing 'Completed'
            setTimeout(()=>{ if (bsModal) bsModal.hide(); }, 700);

          }catch(err){
            console.error(err);
            alert('Unexpected error while running analysis');
            if (bsModal) bsModal.hide();
          }finally{
            rerunBtn.disabled = false;
          }
        });
      })();

      // Handle job application forms
      (function(){
        const successModal = new bootstrap.Modal(document.getElementById('applicationSuccessModal'));
        const applyForms = document.querySelectorAll('.apply-form');

        applyForms.forEach(form => {
          form.addEventListener('submit', function(e){
            e.preventDefault();
            const jobId = form.dataset.jobId;
            const btn = form.querySelector('.apply-btn');
            const originalText = btn.innerText;

            btn.disabled = true;
            btn.innerText = 'Applying...';

            fetch(form.action, {
              method: 'POST',
              headers: {
                'X-Requested-With': 'XMLHttpRequest'
              }
            })
            .then(resp => {
              if (resp.redirected) {
                // Success - show modal
                successModal.show();
                
                // Change button to Applied
                btn.classList.remove('btn-primary');
                btn.classList.add('btn-success');
                btn.innerText = 'Applied';
                
                // Auto-hide modal after 2 seconds
                setTimeout(() => successModal.hide(), 2000);
              } else {
                btn.disabled = false;
                btn.innerText = originalText;
                alert('Failed to apply. Please try again.');
              }
            })
            .catch(err => {
              btn.disabled = false;
              btn.innerText = originalText;
              alert('Error applying to job. Please try again.');
            });
          });
        });
      })();

      // Handle save job buttons
      (function(){
        const saveModal = new bootstrap.Modal(document.getElementById('saveSuccessModal'));
        const saveModalTitle = document.getElementById('save-modal-title');
        const saveModalText = document.getElementById('save-modal-text');
        const saveBtns = document.querySelectorAll('.save-btn');

        saveBtns.forEach(btn => {
          btn.addEventListener('click', function(){
            const jobId = btn.dataset.jobId;
            const wasSaved = btn.classList.contains('btn-warning');

            btn.disabled = true;
            const originalText = btn.innerText;
            btn.innerText = wasSaved ? 'Unsaving...' : 'Saving...';

            fetch(`/seeker/save_job/${jobId}`, {
              method: 'POST',
              headers: {
                'X-Requested-With': 'XMLHttpRequest'
              }
            })
            .then(resp => resp.json())
            .then(data => {
              if (data.status === 'saved') {
                // Show saved modal
                saveModalTitle.innerText = 'Job Saved!';
                saveModalText.innerText = 'Job added to your saved list.';
                saveModal.show();
                
                // Change button to Saved
                btn.classList.remove('btn-outline-secondary');
                btn.classList.add('btn-warning');
                btn.innerText = 'Saved';
                
                // Reload page after 2 seconds to update saved jobs sidebar
                setTimeout(() => {
                  saveModal.hide();
                  location.reload();
                }, 2000);
              } else if (data.status === 'unsaved') {
                // Show unsaved modal
                saveModalTitle.innerText = 'Job Removed';
                saveModalText.innerText = 'Job removed from your saved list.';
                saveModal.show();
                
                // Change button to Save
                btn.classList.remove('btn-warning');
                btn.classList.add('btn-outline-secondary');
                btn.innerText = 'Save';
                
                // Reload page after 2 seconds to update saved jobs sidebar
                setTimeout(() => {
                  saveModal.hide();
                  location.reload();
                }, 2000);
              }
              btn.disabled = false;
            })
            .catch(err => {
              btn.disabled = false;
              btn.innerText = originalText;
              alert('Error saving job. Please try again.');
            });
          });
        });
      })();
    </script>


